"""
Test script to verify authentication works
"""

import sys
from pathlib import Path

# Add backend to path
sys.path.insert(0, str(Path(__file__).parent))

from config.database import supabase

def test_connection():
    """Test Supabase connection"""
    print("Testing Supabase connection...")
    try:
        response = supabase.table('users').select('username').limit(1).execute()
        print(f"[OK] Connected! Found {len(response.data)} users")
        return True
    except Exception as e:
        print(f"[FAIL] Connection failed: {e}")
        return False

def test_user_exists():
    """Test if superadmin exists"""
    print("\nTesting if superadmin exists...")
    try:
        response = supabase.table('users').select('*').eq('username', 'superadmin').execute()
        if response.data:
            user = response.data[0]
            print(f"[OK] User found: {user['username']} - Role: {user['role']}")
            print(f"   ID: {user['id']}")
            print(f"   Active: {user['is_active']}")
            return True
        else:
            print("[FAIL] Superadmin user not found in database!")
            print("   Run database_schema.sql first")
            return False
    except Exception as e:
        print(f"[FAIL] Error: {e}")
        return False

def test_password():
    """Test password verification"""
    print("\nTesting password verification...")
    try:
        from utils.auth import verify_password
        
        # Get user from database
        response = supabase.table('users').select('password_hash').eq('username', 'superadmin').execute()
        if response.data:
            stored_hash = response.data[0]['password_hash']
            
            # Test password
            is_valid = verify_password('Admin123!', stored_hash)
            if is_valid:
                print("[OK] Password verification works!")
                return True
            else:
                print("[FAIL] Password doesn't match")
                return False
        else:
            print("[FAIL] User not found")
            return False
    except Exception as e:
        print(f"[FAIL] Error: {e}")
        return False

if __name__ == "__main__":
    print("="*60)
    print("=== AUTHENTICATION TEST ===")
    print("="*60)
    print()
    
    # Run tests
    test1 = test_connection()
    test2 = test_user_exists()
    test3 = test_password()
    
    print("\n" + "="*60)
    if test1 and test2 and test3:
        print("[OK] ALL TESTS PASSED - Authentication should work!")
    else:
        print("[FAIL] SOME TESTS FAILED - Fix issues above")
    print("="*60)